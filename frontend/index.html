<!-- TODO: slim? -->

<!DOCTYPE HTML>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Dribble</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/css/normalize.css">
    <link rel="stylesheet" href="/css/style.css">
    <script type="text/javascript" src="/elm.js"></script>
  </head>

  <body>
    <div id="app"></div>
  </body>

  <script type="text/javascript">
    var app, ws;

    function connect() {
      const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
      const ws_path = `${protocol}//${location.host}/ws`;

      ws = new WebSocket(ws_path);

      ws.onopen = function(event) {
        // send elm a message to re-get full state?
        app.ports.websocketStatusUpdated.send({connected: true});
      }

      ws.onclose = function(e) {
        console.log('Socket is closed. Reconnect will be attempted in 2 seconds.', e.reason);
        setTimeout(function() {
          connect();
        }, 2000);

        app.ports.websocketStatusUpdated.send({connected: false});
      };

      ws.onerror = function(err) {
        console.error('Socket encountered error: ', err.message, 'Closing socket');
        ws.close();
      };

      ws.onmessage = function(e) {
        //console.log('Message:', e.data);
        app.ports.messageReceiver.send(e.data);
      };
    }

    var storedConfig = localStorage.getItem('app-config');
    console.log("Retrieved config: ", storedConfig);
    var startingConfig = storedConfig ? JSON.parse(storedConfig) : null;

    app = Elm.Main.init({
      node: document.getElementById('app'),
      flags: startingConfig
    });

    app.ports.sendMessage.subscribe(function(message) {
      ws.send(message);
    });

    app.ports.storeConfig.subscribe(function(config) {
      console.log("Saved config: ", config);
      localStorage.setItem('app-config', JSON.stringify(config));
    });

    connect();

  </script>
</html>
